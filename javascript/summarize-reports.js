/**
 * This script uses the raw reports generated by axe-core from the evaluate-and-save-reports.js and
 * creates a CSV file that summarizes the reports in a flattened format.
 * You need to first run the evaluate-and-save-reports.js script to generate the raw reports.
 */
const fs = require('fs');

/** configure input data */
const TIME_STAMP_FOLDER_NAME = process.argv[2];
if(!TIME_STAMP_FOLDER_NAME) {
  console.error('Please provide a timestamp folder name as an argument.');
  return;
}
const BASE_PATH = `../data/${TIME_STAMP_FOLDER_NAME}/reports`;

(async () => {
  /** get all the successfully collected raw reports first */
  const rawReports = (await fs.readdirSync(BASE_PATH, { recursive: true })).filter(file => file.endsWith('.json') && !file.includes('failed'));

  /** initialize the reports and issues */
  const reports = {};
  const issues = {};

  rawReports.forEach(async file => {
    reports[file] = {};

    const reportStr = await fs.readFileSync(`${BASE_PATH}/${file}`);
    const report = JSON.parse(reportStr);
    ['violations', 'passes'].forEach(v_or_p => {
      report[v_or_p].forEach(issue => {
        const { id: issueId, impact, tags, description, help, helpUrl, nodes } = issue;
        if(!issues[issueId]) issues[issueId] = { impact, description, help, helpUrl };
        if(!reports[file][issueId]) reports[file][issueId] = {};
        reports[file][issueId][v_or_p] = nodes.length;
      });
    });


    /** Save CSV files */
    let csvContent = '';
    await Object.keys(reports).forEach(file => {
      // file is in the format of [category]/[page_id]_[pate_type].json
      const category = file.split('/')[0]; // e.g., "data portal"
      const page_id = file.split('/')[1].split('_')[0];
      const page_type = file.split('/')[1].split('_')[1].split('.')[0];

      /** Add a header first */
      csvContent += 'category,page_id,page_type,issue,violations,passes,total_checks,failure_rate\n';
      /** Add the content */
      Object.keys(reports[file]).forEach(issue => {
        let { violations, passes } = reports[file][issue];
        violations = violations ?? 0;
        passes = passes ?? 0;
        const total_checks = violations + passes;
        const ff = violations / total_checks;
        csvContent += `${category},${page_id},${page_type},${issue},${violations},${passes},${total_checks},${ff}\n`;
      });
    });
    fs.writeFileSync(`${BASE_PATH}/accessibility-status.csv`, csvContent, error => {
      if(error) console.error(error);
    });
    let issuesContent = '';
    /** Add a header first */
    issuesContent += 'issue_id,impact,description\n';
    /** Add the content */
    await Object.keys(issues).forEach(issueId => {
      const { impact, description, help, helpUrl } = issues[issueId];
      issuesContent += `${issueId},${impact},"${description}"\n`;
    });
    fs.writeFileSync(`${BASE_PATH}/unique-issues.csv`, issuesContent, error => {
      if(error) console.error(error);
    });
  });
})();
